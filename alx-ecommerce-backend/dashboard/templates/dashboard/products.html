{% extends "dashboard/base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0"><i class="fas fa-box me-2"></i>Products</h2>
        <p class="text-muted mb-0">Manage your product inventory</p>
    </div>
    <a href="{% url 'product_create' %}" class="btn btn-primary">
        <i class="fas fa-plus-circle me-1"></i> Add New Product
    </a>
</div>

<!-- Filters and Search -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-2">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search products...">
                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">Clear</button>
                </div>
            </div>
            <div class="col-md-3 mb-2">
                <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.name|lower }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <select class="form-select" id="stockFilter">
                    <option value="">All Stock Status</option>
                    <option value="inStock">In Stock</option>
                    <option value="lowStock">Low Stock</option>
                    <option value="outOfStock">Out of Stock</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Stats Overview -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-primary h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-primary text-uppercase mb-1">Total Products</div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ products.paginator.count|default:0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-boxes fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-success h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-success text-uppercase mb-1">In Stock</div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ in_stock|default:0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-warning h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-warning text-uppercase mb-1">Low Stock</div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ low_stock|default:0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-danger h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs fw-bold text-danger text-uppercase mb-1">Out of Stock</div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ out_of_stock|default:0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="card shadow-sm">
    <div class="card-header bg-light py-3">
        <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Product List</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="productsTable">
                <thead class="table-light">
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>Image</th>
                        <th>Product</th>
                        <th>Brand</th>
                        <th>Weight (kg)</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Category</th>
                        <th>Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr data-product-id="{{ product.id }}"
                        data-product-name="{{ product.name }}"
                        data-product-brand="{{ product.brand|default:'-' }}"
                        data-product-weight="{{ product.weight|default:'-' }}"
                        data-product-price="{{ product.price }}"
                        data-product-stock="{{ product.stock }}"
                        data-product-category="{{ product.category.name|default:'Uncategorized' }}"
                        data-product-status="{% if product.is_active %}Active{% else %}Inactive{% endif %}"
                        data-product-image="{% if product.image %}{{ product.image.url }}{% else %}''{% endif %}">
                        <td><input type="checkbox" class="product-checkbox" data-id="{{ product.id }}"></td>
                        <td>
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="rounded" width="60" height="60">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="fas fa-box text-muted"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-0">{{ product.name }}</h6>
                                    <small class="text-muted">ID: {{ product.id }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ product.brand|default:"-" }}</td>
                        <td>{{ product.weight|default:"-" }}</td>
                        <td class="fw-bold">${{ product.price }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                    <div class="progress-bar {% if product.stock > 10 %}bg-success{% elif product.stock > 0 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         role="progressbar" style="width: {% widthratio product.stock 50 100 %}%;" 
                                         aria-valuenow="{{ product.stock }}" aria-valuemin="0" aria-valuemax="50">
                                    </div>
                                </div>
                                <span>{{ product.stock }}</span>
                            </div>
                        </td>
                        <td>{{ product.category.name|default:"Uncategorized" }}</td>
                        <td>
                            {% if product.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary view-details-btn" data-bs-toggle="modal" data-bs-target="#productDetailsModal" data-bs-toggle="tooltip" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="window.location.href=&quot;{% url 'product_update' product.id %}&quot;" data-bs-toggle="tooltip" title="Edit Order">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="window.location.href=&quot;{% url 'product_delete' product.id %}&quot;" data-bs-toggle="tooltip" title="Delete Order">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No products found. <a href="{% url 'product_create' %}">Add your first product</a></p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted" id="selectedCount">0 products selected</span>
            </div>
            <div>
                <button class="btn btn-outline-danger btn-sm" id="bulkDeleteBtn" disabled>
                    <i class="fas fa-trash me-1"></i> Delete Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if products.has_other_pages %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if products.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ products.previous_page_number }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% endif %}

        {% for i in products.paginator.page_range %}
            {% if products.number == i %}
            <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
            {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
            {% endif %}
        {% endfor %}

        {% if products.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ products.next_page_number }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productDetailsModalLabel">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <img id="modalProductImage" src="" alt="Product Image" class="img-fluid rounded" style="max-width: 100%;">
                        <div id="modalNoImage" class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 100%; height: 200px; display: none;">
                            <i class="fas fa-box text-muted fa-3x"></i>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h6>ID: <span id="modalProductId"></span></h6>
                        <p><strong>Name:</strong> <span id="modalProductName"></span></p>
                        <p><strong>Brand:</strong> <span id="modalProductBrand"></span></p>
                        <p><strong>Weight:</strong> <span id="modalProductWeight"></span> kg</p>
                        <p><strong>Price:</strong> $<span id="modalProductPrice"></span></p>
                        <p><strong>Stock:</strong> <span id="modalProductStock"></span></p>
                        <p><strong>Category:</strong> <span id="modalProductCategory"></span></p>
                        <p><strong>Status:</strong> <span id="modalProductStatus" class="badge"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-primary" id="modalEditButton" onclick="window.location.href='#'">Edit</button>
                <button class="btn btn-sm btn-danger" id="modalDeleteButton" onclick="window.location.href='#'">Delete</button>
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
/* تجاوز أنماط الأزرار لتكون فاتحة */
.btn-outline-primary {
    color: #3b82f6 !important;
    border-color: #3b82f6 !important;
    background-color: transparent !important;
}
.btn-outline-primary:hover {
    color: #fff !important;
    background-color: #3b82f6 !important;
}

.btn-outline-success {
    color: #10b981 !important;
    border-color: #10b981 !important;
    background-color: transparent !important;
}
.btn-outline-success:hover {
    color: #fff !important;
    background-color: #10b981 !important;
}

.btn-outline-danger {
    color: #ef4444 !important;
    border-color: #ef4444 !important;
    background-color: transparent !important;
}
.btn-outline-danger:hover {
    color: #fff !important;
    background-color: #ef4444 !important;
}

/* التأكد من أن الأزرار في الجدول ليست متأثرة بالخلفية الغامقة */
.btn-group .btn {
    border-radius: 6px !important;
    opacity: 1 !important; /* التأكد من أن الأزرار مرئية */
}

/* استمرار أنماط الصفحة الأصلية */
.card {
    border: none;
    border-radius: 12px;
}

.table th {
    border-top: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
    color: #6c757d;
}

.table td {
    vertical-align: middle;
}

.border-start-primary {
    border-left: 4px solid #4e73df !important;
}

.border-start-success {
    border-left: 4px solid #1cc88a !important;
}

.border-start-warning {
    border-left: 4px solid #f6c23e !important;
}

.border-start-danger {
    border-left: 4px solid #e74a3b !important;
}

.progress {
    width: 80px;
}

#searchInput {
    border-radius: 8px 0 0 8px;
}

#clearSearch {
    border-radius: 0 8px 8px 0;
}

.pagination .page-link {
    border-radius: 8px;
    margin: 0 3px;
    border: none;
    color: #6c757d;
}

.pagination .page-item.active .page-link {
    background-color: #4e73df;
    border-color: #4e73df;
}

.modal-content {
    border-radius: 12px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const table = document.getElementById('productsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    searchInput.addEventListener('keyup', function() {
        const filter = searchInput.value.toLowerCase();
        for (let i = 0; i < rows.length; i++) {
            const name = rows[i].getElementsByTagName('td')[2].textContent.toLowerCase();
            const brand = rows[i].getElementsByTagName('td')[3].textContent.toLowerCase();
            if (name.includes(filter) || brand.includes(filter)) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    });

    clearSearch.addEventListener('click', function() {
        searchInput.value = '';
        for (let i = 0; i < rows.length; i++) {
            rows[i].style.display = '';
        }
    });

    // Bulk selection
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.product-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

    selectAll.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        updateSelectedCount();
    });

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    function updateSelectedCount() {
        const selected = document.querySelectorAll('.product-checkbox:checked');
        selectedCount.textContent = `${selected.length} products selected`;
        bulkDeleteBtn.disabled = selected.length === 0;
    }

    // Bulk delete (placeholder)
    bulkDeleteBtn.addEventListener('click', function() {
        const selected = document.querySelectorAll('.product-checkbox:checked');
        const selectedIds = Array.from(selected).map(checkbox => checkbox.getAttribute('data-id'));
        if (confirm(`Are you sure you want to delete ${selectedIds.length} products?`)) {
            console.log('Products to delete:', selectedIds);
            alert('Bulk delete functionality would be implemented here.');
        }
    });

    // Filter functionality
    const categoryFilter = document.getElementById('categoryFilter');
    const stockFilter = document.getElementById('stockFilter');

    categoryFilter.addEventListener('change', filterProducts);
    stockFilter.addEventListener('change', filterProducts);

    function filterProducts() {
        const categoryValue = categoryFilter.value;
        const stockValue = stockFilter.value;
        for (let i = 0; i < rows.length; i++) {
            const category = rows[i].getElementsByTagName('td')[7].textContent.toLowerCase();
            const stockStatus = rows[i].getElementsByTagName('td')[6].textContent.toLowerCase();
            const categoryMatch = !categoryValue || category.includes(categoryValue);
            const stockMatch = !stockValue || 
                (stockValue === 'inStock' && parseInt(stockStatus) > 10) ||
                (stockValue === 'lowStock' && parseInt(stockStatus) > 0 && parseInt(stockStatus) <= 10) ||
                (stockValue === 'outOfStock' && parseInt(stockStatus) === 0);
            if (categoryMatch && stockMatch) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }

    // View details modal
    const viewDetailsButtons = document.querySelectorAll('.view-details-btn');
    viewDetailsButtons.forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            const productId = row.dataset.productId;
            const productName = row.dataset.productName;
            const productBrand = row.dataset.productBrand;
            const productWeight = row.dataset.productWeight;
            const productPrice = row.dataset.productPrice;
            const productStock = row.dataset.productStock;
            const productCategory = row.dataset.productCategory;
            const productStatus = row.dataset.productStatus;
            const productImage = row.dataset.productImage;

            // Populate modal fields
            document.getElementById('modalProductId').textContent = productId;
            document.getElementById('modalProductName').textContent = productName;
            document.getElementById('modalProductBrand').textContent = productBrand;
            document.getElementById('modalProductWeight').textContent = productWeight;
            document.getElementById('modalProductPrice').textContent = productPrice;
            document.getElementById('modalProductStock').textContent = productStock;
            document.getElementById('modalProductCategory').textContent = productCategory;
            const statusBadge = document.getElementById('modalProductStatus');
            statusBadge.textContent = productStatus;
            statusBadge.className = 'badge ' + (productStatus === 'Active' ? 'bg-success' : 'bg-secondary');

            // Handle image
            const modalImage = document.getElementById('modalProductImage');
            const noImageDiv = document.getElementById('modalNoImage');
            if (productImage && productImage !== "''") {
                modalImage.src = productImage;
                modalImage.style.display = 'block';
                noImageDiv.style.display = 'none';
            } else {
                modalImage.style.display = 'none';
                noImageDiv.style.display = 'flex';
            }

            // Update Edit and Delete buttons in modal
            document.getElementById('modalEditButton').setAttribute('onclick', `window.location.href='/dashboard/products/${productId}/update/'`);
            document.getElementById('modalDeleteButton').setAttribute('onclick', `window.location.href='/dashboard/products/${productId}/delete/'`);
        });
    });
});
</script>
{% endblock %}